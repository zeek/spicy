#!/usr/bin/env bash

# This script regenerates documentation files. Running it again a `master`
# commit should not produce any changes.
#
# TODO(bbannier): Execute this script via a pre-commit hook to prevent the
# in-tree generated docs from getting out of sync with the code.

set -o errexit
set -o nounset

ROOTDIR="$(cd "$( dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)/.."
BUILDDIR="${ROOTDIR}/build"
SPICYDOC="${BUILDDIR}/bin/spicy-doc"
SPICYDTR="${ROOTDIR}/doc/scripts/spicy-doc-to-rst"
AUTOGEN="${ROOTDIR}/doc/autogen"

rm -rf "${AUTOGEN}" && mkdir -p ${AUTOGEN}

"${ROOTDIR}/doc/scripts/autogen-spicy-lib" functions spicy < "${ROOTDIR}/spicy/lib/spicy.spicy"        > "${AUTOGEN}/spicy-functions.spicy"
"${ROOTDIR}/doc/scripts/autogen-spicy-lib" types     spicy < "${ROOTDIR}/spicy/lib/spicy.spicy"        > "${AUTOGEN}/spicy-types.spicy"
"${ROOTDIR}/doc/scripts/autogen-spicy-lib" types     spicy < "${ROOTDIR}/spicy/lib/filter.spicy"       > "${AUTOGEN}/filter-types.spicy"
"${ROOTDIR}/doc/scripts/autogen-spicy-lib" functions zeek  < "${ROOTDIR}/zeek/plugin/spicy/zeek.spicy" > "${AUTOGEN}/zeek-functions.spicy"

# Include these namespaces into the autogenerated type reference.
if [[ ! -x ${BUILDDIR}/bin/spicy-doc ]]; then
    >&2 echo "Could not find required executable ${BUILDDIR}/bin/spicy-doc"
    exit 1
fi
SPICY_TYPES=address,bitfield,bool,bytes,enum,exception,integer,list,port,real,regexp,sink,stream,string,struct,tuple,unit,vector
"${SPICYDOC}" | ${SPICYDTR} -t "${SPICY_TYPES}" -d "${AUTOGEN}/types"
