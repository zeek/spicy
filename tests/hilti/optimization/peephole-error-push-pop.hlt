# @TEST-REQUIRES: which FileCheck
# @TEST-EXEC: hiltic -V -p %INPUT -o output.hlt
# @TEST-EXEC: FileCheck %INPUT < output.hlt
#
# @TEST-DOC: Test removal of redundant $error assignments.

# NOTE: While by default the error variable is name `$error` the optimizer pass
# also allows `__error` so we do not have to extend the parser to support
# constructs likely
#
#     global Foo foo = [$$error=0];
#

module Test {

type Foo = struct {
    method void test();
    int<64> __error; # name is internal, hence compiling with -V; type does not matter
};

# We expect the full body of this function to be removed:
#
# - error push/pop removed
# - now unused `$error` removed
#
# CHECK: function void Foo::test() {
# CHECK-NEXT: }
function void Foo::test() {
    local int<64> __error;
    (*self).__error = __error;
    __error = (*self).__error;
}

global Foo foo = [$__error=0];
foo.test();

}
